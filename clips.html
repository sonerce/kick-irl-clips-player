<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kick Clips Player</title>
    <!-- HLS.js kÃ¼tÃ¼phanesi -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000000;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #videoPlayer {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: #000;
        }

        .error-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #000;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            text-align: center;
        }

        .error-message {
            background-color: #1a1a1a;
            padding: 40px;
            border-radius: 10px;
            border: 2px solid #ff5252;
        }

        .error-message h1 {
            color: #ff5252;
            margin-bottom: 20px;
        }

        .error-message p {
            color: #aaa;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .loading-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #000;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            flex-direction: column;
        }

        .spinner {
            border: 4px solid #333;
            border-top: 4px solid #53fc18;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2em;
            color: #aaa;
        }

    </style>
</head>
<body>
    <div class="loading-container" id="loadingContainer">
        <div class="spinner"></div>
        <div class="loading-text">Klipler yÃ¼kleniyor...</div>
    </div>
    
    <video id="videoPlayer" style="display: none;" controls autoplay></video>

    <script>
        let clips = [];
        let currentClipIndex = 0;
        let hls = null;

        // URL parametrelerini al
        const params = new URLSearchParams(window.location.search);
        const streamerName = params.get('streamerName');
        const duration = params.get('duration') || 'week';

        if (!streamerName) {
            showError('Streamer adÄ± belirtilmedi!', 'URL parametrelerini kontrol edin.');
        } else {
            loadClips(streamerName, duration);
        }

        async function loadClips(streamer, duration) {
            try {
                const response = await fetch(`https://kick.com/api/v2/channels/${streamer}/clips?time=${duration}`);
                
                if (!response.ok) {
                    throw new Error(`API hatasÄ±: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.clips || data.clips.length === 0) {
                    throw new Error('Bu kanal iÃ§in klip bulunamadÄ±.');
                }
                
                // Klipleri karÄ±ÅŸtÄ±r
                clips = shuffleArray(data.clips);
                currentClipIndex = 0;
                
                console.log(`${clips.length} klip yÃ¼klendi ve karÄ±ÅŸtÄ±rÄ±ldÄ±.`);
                console.log('Ä°lk klip:', clips[0]);
                console.log('Ä°lk klibin alanlarÄ±:', Object.keys(clips[0]));
                
                // Ä°lk klibi oynat
                playClip(currentClipIndex);
                
            } catch (error) {
                console.error('Hata:', error);
                showError('Klipler yÃ¼klenemedi!', error.message);
            }
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function playClip(index) {
            if (clips.length === 0) return;
            
            const clip = clips[index];
            const videoPlayer = document.getElementById('videoPlayer');
            const loadingContainer = document.getElementById('loadingContainer');
            
            console.log(`\n=== Klip ${index + 1}/${clips.length} ===`);
            console.log('BaÅŸlÄ±k:', clip.title);
            console.log('Klip Objesi:', clip);
            
            // Video URL'sini bul
            let videoUrl = findVideoUrl(clip);
            
            if (!videoUrl) {
                console.error('Video URL bulunamadÄ±! Sonraki klibe geÃ§iliyor...');
                setTimeout(() => nextClip(), 2000);
                return;
            }
            
            console.log('KullanÄ±lacak Video URL:', videoUrl);
            
            // Loading'i gizle, video player'Ä± gÃ¶ster
            loadingContainer.style.display = 'none';
            videoPlayer.style.display = 'block';
            
            // HLS kullanarak videoyu oynat
            loadVideo(videoPlayer, videoUrl);
            
            // Video bitince sonraki klibe geÃ§
            videoPlayer.onended = () => {
                console.log('Video bitti, sonraki klibe geÃ§iliyor...');
                setTimeout(() => nextClip(), 500);
            };
            
            // Video hata durumunda
            videoPlayer.onerror = (e) => {
                console.error('Video yÃ¼kleme hatasÄ±:', e);
                console.error('Video player error:', videoPlayer.error);
                setTimeout(() => nextClip(), 2000);
            };
        }

        function findVideoUrl(clip) {
            // OlasÄ± video URL alanlarÄ±nÄ± kontrol et
            const possibleFields = [
                'video_url',
                'clip_url',
                'source_url',
                'playback_url',
                'url'
            ];
            
            // Direkt alanlarda ara
            for (const field of possibleFields) {
                if (clip[field]) {
                    console.log(`âœ“ Video URL "${field}" alanÄ±nda bulundu`);
                    return clip[field];
                }
            }
            
            // Nested objelerde ara
            if (clip.video) {
                if (clip.video.url) return clip.video.url;
                if (clip.video.source) return clip.video.source;
                if (clip.video.playback_url) return clip.video.playback_url;
            }
            
            if (clip.livestream) {
                if (clip.livestream.playback_url) return clip.livestream.playback_url;
                if (clip.livestream.source) return clip.livestream.source;
            }
            
            // Thumbnail'dan video URL'i tahmin et (son Ã§are)
            if (clip.thumbnail_url) {
                const guessedUrl = clip.thumbnail_url
                    .replace('/thumbnail.jpg', '/video.mp4')
                    .replace('/thumbnail.png', '/video.mp4')
                    .replace('-thumbnail', '');
                console.log('âš  Video URL thumbnail\'den tahmin edildi');
                return guessedUrl;
            }
            
            return null;
        }

        function loadVideo(videoElement, videoUrl) {
            // Ã–nceki HLS instance'Ä± temizle
            if (hls) {
                hls.destroy();
                hls = null;
            }
            
            // URL'nin formatÄ±nÄ± kontrol et
            if (videoUrl.includes('.m3u8')) {
                // HLS stream
                if (Hls.isSupported()) {
                    hls = new Hls({
                        debug: false,
                        enableWorker: true,
                        lowLatencyMode: false,
                        backBufferLength: 90
                    });
                    
                    hls.loadSource(videoUrl);
                    hls.attachMedia(videoElement);
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        console.log('HLS manifest yÃ¼klendi, video oynatÄ±lÄ±yor...');
                        videoElement.muted = false;
                        videoElement.volume = 1.0;
                        videoElement.play().catch(err => {
                            console.warn('Autoplay hatasÄ±:', err);
                        });
                    });
                    
                    hls.on(Hls.Events.ERROR, function(event, data) {
                        console.error('HLS HatasÄ±:', data);
                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    console.error('Network hatasÄ±, yeniden deneniyor...');
                                    hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    console.error('Media hatasÄ±, kurtarma deneniyor...');
                                    hls.recoverMediaError();
                                    break;
                                default:
                                    console.error('Fatal hata, sonraki klibe geÃ§iliyor...');
                                    setTimeout(() => nextClip(), 1000);
                                    break;
                            }
                        }
                    });
                } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                    // Safari native HLS desteÄŸi
                    videoElement.src = videoUrl;
                    videoElement.muted = false;
                    videoElement.volume = 1.0;
                    videoElement.play().catch(err => {
                        console.warn('Autoplay hatasÄ±:', err);
                    });
                }
            } else {
                // Normal MP4 veya diÄŸer format
                videoElement.src = videoUrl;
                videoElement.muted = false;
                videoElement.volume = 1.0;
                videoElement.load();
                videoElement.play().catch(err => {
                    console.warn('Autoplay hatasÄ±:', err);
                });
            }
        }

        function nextClip() {
            if (clips.length === 0) return;
            
            // Bir sonraki klibe geÃ§
            currentClipIndex = (currentClipIndex + 1) % clips.length;
            
            // TÃ¼m klipler bittiyse, karÄ±ÅŸtÄ±r ve baÅŸa dÃ¶n
            if (currentClipIndex === 0) {
                console.log('\nðŸ”„ TÃ¼m klipler oynatÄ±ldÄ±, karÄ±ÅŸtÄ±rÄ±lÄ±yor...\n');
                clips = shuffleArray(clips);
            }
            
            playClip(currentClipIndex);
        }

        function showError(title, message) {
            document.body.innerHTML = `
                <div class="error-container">
                    <div class="error-message">
                        <h1>${title}</h1>
                        <p>${message}</p>
                    </div>
                </div>
            `;
        }

        // Klavye kÄ±sayollarÄ± (debug iÃ§in)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextClip();
            } else if (e.key === 'r' || e.key === 'R') {
                clips = shuffleArray(clips);
                currentClipIndex = 0;
                playClip(currentClipIndex);
            } else if (e.key === 'm' || e.key === 'M') {
                // Mute toggle
                const video = document.getElementById('videoPlayer');
                video.muted = !video.muted;
                console.log('Mute:', video.muted);
            }
        });

        // Visibility API
        document.addEventListener('visibilitychange', () => {
            const videoPlayer = document.getElementById('videoPlayer');
            
            if (document.hidden) {
                videoPlayer.pause();
            } else {
                videoPlayer.play().catch(err => {
                    console.error('Resume hatasÄ±:', err);
                });
            }
        });
    </script>
</body>
</html>
